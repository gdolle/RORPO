language: C++

os:
  - linux

dist: focal # 20.04

compiler:
  - gcc

addons:
  apt:
    update: true
    packages:
      - libdocopt-dev
      - libfftw3-dev
      - libinsighttoolkit4-dev
      - libgdcm-dev
      - libgdcm-tools
      - libvtkgdcm-dev
      - libvtkgdcm-tools
      # Python 
      - insighttoolkit4-python3
      - python3-gdcm
      - python3-vtkgdcm
      # Build
      - g++
      - cmake
      - make
      # Packages
      - dpkg

stages:
  - build
  - test
  - packages
  - name: deploy
    if: branch = master

jobs:
  include:
    - stage: build
      script:
        - mkdir build
        - cd build
        - cmake ..
        - make -j2

    - stage: build packages
      script:
        - make package

    - stage: test
      script:
        - echo "RORPO Unit tests"

    - stage: deploy GitHub Release
      if: branch = master
      script: echo "Deploying to GitHub releases ..."
      deploy:
        provider: releases
        file: 
          #- rorpo-1.0.0-Linux.tar.gz
        api_key: $GITHUB_OAUTH_TOKEN
        cleanup: false
        on:
          tags: true
